# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the Pulumi Service Provider (PSP), a Pulumi provider built on top of the Pulumi Cloud REST API that allows managing Pulumi Cloud resources (Stacks, Environments, Teams, Tokens, Webhooks, Deployment Settings, etc.) using Pulumi programs.

The provider is written in Go and generates SDKs for multiple languages (Node.js/TypeScript, Python, Go, .NET, Java).

## Repository Structure

- `provider/` - Core provider implementation in Go
  - `provider/cmd/pulumi-resource-pulumiservice/` - Main provider binary and schema.json
  - `provider/pkg/provider/` - Provider server implementation (gRPC)
  - `provider/pkg/pulumiapi/` - HTTP client wrappers for Pulumi Cloud REST API
  - `provider/pkg/resources/` - Resource implementations (teams, stacks, webhooks, etc.)
  - `provider/pkg/util/` - Utility functions for property handling, diffs, secrets
- `sdk/` - Generated SDKs for each language (dotnet, go, java, nodejs, python)
- `examples/` - Example programs in various languages demonstrating provider usage

## Makefile Architecture

This provider uses a **custom Makefile** (not autogenerated by ci-mgmt) because it's a native provider.

### Key Characteristics

- **No codegen binary**: Unlike Terraform-bridged providers, this provider doesn't have a separate `pulumi-gen-*` binary
- **Direct SDK generation**: Uses `pulumi package gen-sdk schema.json` to generate SDKs directly from the schema file
- **Schema embedding**: The `schema.json` file is embedded into the provider binary using `//go:embed`
- **Custom targets**: Includes provider-specific targets like `fmt`, `lint`, and `upstream`

### Makefile Structure

```makefile
# SDK generation targets use pulumi CLI directly
.make/generate_nodejs: $(PULUMI) $(SCHEMA_FILE)
	$(PULUMI) package gen-sdk $(SCHEMA_FILE) --language nodejs --out sdk/nodejs

# Provider binary embeds schema.json
provider:: $(SCHEMA_FILE)
	(cd provider && go build -o $(WORKING_DIR)/bin/$(PROVIDER) -ldflags $(LDFLAGS) $(BUILD_PATH))
```

**Important**: Do not replace this Makefile with a ci-mgmt generated one - it will break the build since generic/bridged templates assume a codegen binary exists.

## Build Commands

### Essential Commands

```bash
# Restore/install build dependencies
make ensure

# Build provider binary only
make provider

# Build all SDKs (requires provider to be built first)
make build_sdks

# Build everything (provider + all SDKs)
make build

# Run provider tests
make test_provider

# Run linting (runs golangci-lint in provider, sdk, and examples directories)
make lint

# Format all code using golangci-lint fmt (runs in provider, sdk, and examples)
make fmt

# Generate schema (alias: make codegen or make generate_schema for CI compatibility)
make schema
```

**Note**: `make codegen` and `make generate_schema` are aliases for `make schema` provided for CI workflow compatibility. Native providers don't have a separate codegen binary - they use `go generate` to update the embedded schema.json file.

### SDK-Specific Commands

```bash
make nodejs_sdk    # Build Node.js/TypeScript SDK
make python_sdk    # Build Python SDK
make go_sdk        # Build Go SDK
make dotnet_sdk    # Build .NET SDK
make java_sdk      # Build Java SDK
```

### Installation Commands

```bash
make install              # Install provider binary and Node.js/dotnet SDKs
make install_nodejs_sdk   # Link Node.js SDK locally via yarn
make install_java_sdk     # Publish Java SDK to local Maven
```

## Environment Variables

- **Integration Tests**: This project uses `.env` file for local testing credentials
  - `PULUMI_ACCESS_TOKEN`: Token for authenticating with Pulumi Cloud
  - `PULUMI_TEST_OWNER`: Organization name for tests (defaults to `service-provider-test-org` if not set)
  - These variables are loaded automatically by the test framework when present in `.env`
  - The `.env` file is gitignored for security

### Testing

```bash
# Run provider unit tests
cd provider/pkg && go test -short -v -count=1 -cover -timeout 2h -parallel 4 ./...

# Run example tests (integration tests)
cd examples && go test -tags=all -v -count=1 -timeout 3h -parallel 4

# Run specific example test
cd examples && go test -v -run TestYamlStackTagsPluralExample -tags yaml -timeout 10m
```

- Integration tests are located in `examples/` directory
- Tests are tagged: use `-tags yaml`, `-tags nodejs`, `-tags python`, etc.
- The `.env` file allows running integration tests locally against a custom organization
- Every new resource should have unit tests in `provider/pkg/` with `_test.go` suffix
- Add example programs in `examples/` for each new resource (examples serve as integration tests)
- Examples are organized by language: `ts-*`, `py-*`, `go-*`, `cs-*`, `java-*`, `yaml-*`

## Development Workflow

### Copyright Headers

**IMPORTANT**: All new files must have correct copyright year ranges:
- In 2025: Use `// Copyright 2016-2025, Pulumi Corporation.`
- In 2026: Use `// Copyright 2016-2026, Pulumi Corporation.`
- General rule: Always use current year as the end year for new files

### CHANGELOG Updates

**IMPORTANT**: Always update `CHANGELOG.md` when making code changes that affect users:

1. Add an entry under the `## Unreleased` section
2. If `## Unreleased` doesn't exist, create it at the top of the file (after the `# CHANGELOG` header)
3. Categorize changes appropriately:
   - `### Improvements` - New features, enhancements, new resources
   - `### Bug Fixes` - Bug fixes, corrections
   - `### Breaking Changes` - Breaking changes (rare, requires major version bump)
4. Format: `- Description of change [#issue_or_pr_number](link_to_issue_or_pr)`
5. Examples:
   - `- Added StackTags resource for managing multiple stack tags [#61](https://github.com/pulumi/pulumi-pulumiservice/issues/61)`
   - `- Fixed OIDC Issuer policies order to prevent accidental drifts [#542](https://github.com/pulumi/pulumi-pulumiservice/pull/542)`

### Schema Changes

The provider schema is **manually maintained** at `provider/cmd/pulumi-resource-pulumiservice/schema.json`. When adding/modifying resources:

1. Update `schema.json` with the new resource/property definitions
2. Run `make provider` to regenerate the provider binary (uses `go generate`)
3. Run `make build_sdks` to regenerate all language SDKs from the schema
4. The schema is embedded into the provider binary at build time

### Adding a New Resource

1. Add resource definition to `provider/cmd/pulumi-resource-pulumiservice/schema.json`
2. Create API client methods in `provider/pkg/pulumiapi/` (e.g., `teams.go`, `webhooks.go`)
3. Create resource implementation in `provider/pkg/resources/` implementing `PulumiServiceResource` interface
4. Register the resource in `provider/pkg/provider/provider.go`
5. Rebuild provider and SDKs: `make build`
6. Add examples in `examples/` directory
7. **IMPORTANT**: Always create a YAML example for the new resource:
   - Add a `yaml-*` example directory in `examples/`
   - Create a `README.md` in the example directory that includes a link to the `pulumi convert` documentation (https://www.pulumi.com/docs/iac/cli/commands/pulumi_convert/) for converting the example to other programming languages
   - Register the example test in `examples/examples_yaml_test.go`
   - Test the YAML example before completing: `cd examples && go test -v -run TestYaml<ResourceName>Example -tags yaml -timeout 10m`

### Resource Interface

All resources must implement the `PulumiServiceResource` interface:

```go
type PulumiServiceResource interface {
    Diff(req *pulumirpc.DiffRequest) (*pulumirpc.DiffResponse, error)
    Create(req *pulumirpc.CreateRequest) (*pulumirpc.CreateResponse, error)
    Delete(req *pulumirpc.DeleteRequest) (*pbempty.Empty, error)
    Check(req *pulumirpc.CheckRequest) (*pulumirpc.CheckResponse, error)
    Update(req *pulumirpc.UpdateRequest) (*pulumirpc.UpdateResponse, error)
    Read(req *pulumirpc.ReadRequest) (*pulumirpc.ReadResponse, error)
    Name() string
}
```

## API Client Architecture

The `pulumiapi` package provides HTTP client wrappers for the Pulumi Cloud REST API:

- `Client` - Base HTTP client with authentication and standard headers
- Individual files for each resource type (e.g., `teams.go`, `stack.go`, `webhooks.go`)
- All API calls use the standard headers: `X-Pulumi-Source: provider`, `Accept: application/vnd.pulumi+8`
- Authentication via Bearer token in `Authorization` header

## Release Process

Releases are handled by Pulumi employees via `#release-ops` Slack channel. GitHub Actions automatically builds, tests, and publishes new releases to all package managers.

## Configuration

Provider accepts two configuration options:
- `accessToken` (env: `PULUMI_ACCESS_TOKEN`) - Pulumi Service access token
- `apiUrl` (env: `PULUMI_BACKEND_URL`) - Custom API URL for self-hosted instances

## Version Management

- Provider version is set via `PROVIDER_VERSION` environment variable or defaults to `1.0.0-alpha.0+dev`
- Version is injected into provider binary via LDFLAGS at build time
- The Pulumi CLI binary version used for SDK generation is automatically synced with the `github.com/pulumi/pulumi/pkg/v3` dependency version

## CI Management (ci-mgmt)

This provider uses Pulumi's [ci-mgmt](https://github.com/pulumi/ci-mgmt) tool to generate GitHub Actions workflows. Configuration is in `.ci-mgmt.yaml`.

### Provider Template Types

- **`generic` template**: For Terraform-bridged providers that have a separate codegen binary (`pulumi-gen-*`). Generates Makefile with tfgen targets.
- **`native` template**: For hand-written providers (like this one) that don't use tfgen. Does NOT generate a Makefile - providers must maintain their own.
- **`aws-native` template**: Special template for AWS Native provider.

**This provider uses `template: native`** because:
- It's a hand-written provider (not bridged from Terraform)
- Uses `schema.json` directly with `pulumi package gen-sdk` (no separate codegen binary)
- Maintains a custom Makefile

### Regenerating Workflows

```bash
# Regenerate all GitHub Actions workflows from .ci-mgmt.yaml
make ci-mgmt
# OR
go run github.com/pulumi/ci-mgmt/provider-ci@master generate
```

**Important**:
- GitHub workflow files (`.github/workflows/*.yml`) are autogenerated and have a warning header
- The `Makefile` is NOT autogenerated for native providers - it's a custom file
- Changes to workflows should be made via `.ci-mgmt.yaml`, then regenerated

### Configuration via .ci-mgmt.yaml

Key configuration options:

```yaml
template: native                    # Provider template type
provider: pulumiservice            # Provider name
major-version: 0                   # Major version for releases
providerDefaultBranch: main        # Main branch name
envOverride:                       # Environment variables for ALL workflows
    GOLANGCI_LINT_VERSION: v2.5.0  # Override default golangci-lint version
    AWS_REGION: us-west-2          # Custom AWS region
env:                               # Additional environment variables
    PROVIDER: pulumiservice        # Provider name for scripts
    PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
```

**envOverride vs env**:
- `envOverride`: Merges into the global `env:` section of all workflows (higher priority)
- `env`: Additional environment variables specific to this provider

### golangci-lint Configuration

The workflows use golangci-lint v2.5.0 (official release from September 2025). Configuration:

```yaml
envOverride:
    GOLANGCI_LINT_VERSION: v2.5.0  # Sets ${{ env.GOLANGCI_LINT_VERSION }}
```

This ensures all workflows use the correct golangci-lint version. The version format is `v2.5.0` (with `v` prefix) for GitHub Actions.

## Linting and Formatting

This project uses **golangci-lint v2.5.0**, which includes both linting and formatting capabilities.

### Linting

The Makefile provides `make lint` which runs golangci-lint in three directories: `provider`, `sdk`, and `examples` with a 10-minute timeout.

**Important**: When linting the `examples/` directory, you must use the `--build-tags all` flag because the test files use build tags (yaml, nodejs, python, etc.):

```bash
cd examples && golangci-lint run --timeout 10m --build-tags all
```

Without the build tags, golangci-lint may report false positives about unused functions that are actually used in files with specific build tags.

### Formatting

**golangci-lint v2.5.0** includes a built-in `fmt` command that can format code using various formatters:

```bash
# Format code automatically
make fmt

# Preview formatting changes without applying them
golangci-lint fmt -c .golangci.yml --diff

# Format with specific formatters enabled
golangci-lint fmt -c .golangci.yml -E gofmt -E goimports
```

Available formatters (disabled by default, enable as needed):
- `gci` - Format code and import statements with additional rules
- `gofmt` - Standard Go formatting
- `gofumpt` - Stricter gofmt with additional rules
- `goimports` - Format imports
- `golines` - Fix long lines (useful for line length limits)
- `swaggo` - Format Swagger comments

**Implementation**: `make fmt` runs `golangci-lint fmt -c .golangci.yml` in three directories:
```makefile
.PHONY: fmt
fmt:
	cd provider && golangci-lint fmt -c ../.golangci.yml
	cd sdk && golangci-lint fmt -c ../.golangci.yml
	cd examples && golangci-lint fmt -c ../.golangci.yml
```

**Best Practice**: Always run `make fmt` before `make lint` to automatically fix formatting issues. This saves time and tokens by preventing linting failures due to formatting problems.

## Debugging CI Failures

When investigating CI test failures:

1. **Use GitHub CLI to fetch logs**:
   ```bash
   gh run view <run_id> --log-failed
   gh api repos/pulumi/pulumi-pulumiservice/actions/jobs/<job_id>/logs | grep "error:"
   ```

2. **Check for API validation errors**: The Pulumi Cloud API may reject values that are defined in the schema but not yet implemented (e.g., "runner" token type in OIDC policies)

3. **Check for outdated test data**: Examples may contain hardcoded values like TLS certificate thumbprints that become stale when certificates are rotated

4. **Look for related issues across examples**: If one language example fails, check all language examples (ts-, py-, go-, cs-, yaml-) for the same issue
