name: Setup Policy Packs for Testing

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Clean up existing policy packs first'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - policy-group-schema-fix-issue-594

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  PULUMI_BACKEND_URL: https://api.pulumi-staging.io
  PULUMI_TEST_OWNER: service-provider-test-org

jobs:
  setup-policy-packs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Pulumi CLI
      uses: pulumi/actions@v4

    - name: Login to Pulumi
      run: |
        pulumi login
        pulumi whoami

    - name: Clone policy packs repository
      run: |
        git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/pulumi/policy-packs-internal.git /tmp/policy-packs-internal

    - name: Publish AWS Best Practices Policy Pack
      run: |
        cd /tmp/policy-packs-internal/packs/pulumi-best-practices/aws
        
        # Install dependencies
        npm install
        
        # Publish the policy pack
        pulumi policy publish $PULUMI_TEST_OWNER

    - name: Publish Azure Best Practices Policy Pack
      run: |
        cd /tmp/policy-packs-internal/packs/pulumi-best-practices/azure
        
        # Install dependencies if package.json exists
        if [ -f package.json ]; then
          npm install
        fi
        
        # Publish the policy pack
        pulumi policy publish $PULUMI_TEST_OWNER

    - name: Publish GCP Best Practices Policy Pack
      run: |
        cd /tmp/policy-packs-internal/packs/pulumi-best-practices/gcp
        
        # Install dependencies if package.json exists
        if [ -f package.json ]; then
          npm install
        fi
        
        # Publish the policy pack
        pulumi policy publish $PULUMI_TEST_OWNER

    - name: List published policy packs
      run: |
        echo "Published policy packs in $PULUMI_TEST_OWNER:"
        pulumi policy ls $PULUMI_TEST_OWNER

    - name: Summary
      run: |
        echo "âœ… Successfully published policy packs from policy-packs-internal:"
        echo "  1. pulumi-best-practices/aws - AWS best practices"
        echo "  2. pulumi-best-practices/azure - Azure best practices" 
        echo "  3. pulumi-best-practices/gcp - GCP best practices"
        echo ""
        echo "These policy packs are now available for testing with PolicyGroup resources"
        echo "in the service-provider-test-org organization."