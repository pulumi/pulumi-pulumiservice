name: yaml-policy-groups
description: Example demonstrating PolicyGroup resource and policy pack data sources
runtime: yaml
config:
  digits:
    type: string
  organizationName:
    type: string
    default: service-provider-test-org

variables:
  # Query all available policy packs in the organization
  # This demonstrates using the getPolicyPacks data source
  policyPacks:
    fn::invoke:
      function: pulumiservice:index:getPolicyPacks
      arguments:
        organizationName: ${organizationName}
      return: policyPacks

  # Get detailed information about a specific policy pack (if available)
  # This demonstrates using the getPolicyPack data source and shows
  # detailed policy metadata including severity, framework, tags, etc.
  # Note: This will only work if you have a policy pack named "aws-compliance" version 1
  # Uncomment and modify the policyPackName and version to match your setup
  # policyPackDetail:
  #   fn::invoke:
  #     function: pulumiservice:index:getPolicyPack
  #     arguments:
  #       organizationName: ${organizationName}
  #       policyPackName: "aws-compliance"
  #       version: 1

resources:
  testPolicyGroup:
    type: pulumiservice:PolicyGroup
    properties:
      name: test-policy-group-${digits}
      organizationName: ${organizationName}
      entityType: stacks
      mode: audit
      stacks:
        - name: ${pulumi.stack}
          routingProject: ${pulumi.project}
      policyPacks:
        - name: hitrust-aws
          displayName: ""
          version: 1
          versionTag: 2.4.1
          config:
            hardened-os-image:
              approvedAmiIds:
                - ami-0abcdef1234567890

outputs:
  # Export the policy group name and the list of available policy packs
  policyGroupName: ${testPolicyGroup.name}